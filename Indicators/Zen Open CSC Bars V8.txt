//@version=5
indicator("Zen Open CSC Bars V8", overlay=true)

// === INPUTS ===
numBarsToCheck = input.int(2, "Bars to Check", minval=2, maxval=9)
showLabels = input.bool(true, "Show Bull/Bear Labels")
showSpikeLabel = input.bool(true, "Show Spike Label on Chart", group="Display")
colourBars = input.bool(true, "Colour Bars")
lookbackPeriod = input.int(8, "ABR Lookback Period", minval=1)

// EMA Settings
showEMA20 = input.bool(true, "Show 20 EMA", group="EMAs")
showEMA200 = input.bool(true, "Show 200 EMA", group="EMAs")

// === NEW DAY DETECTION ===
new_day = ta.change(time("D")) != 0
bars_since_new_day = ta.barssince(new_day)
in_session = bars_since_new_day >= 0

// === BAR TYPE ===
is_bull = close > open
is_bear = close < open

// === BAR RANGE CALCULATIONS ===
bar_range = high - low
averageBarRange = ta.sma(bar_range, lookbackPeriod)
barRangeMultiple = averageBarRange > 0 ? bar_range / averageBarRange : 0

// === ORIGINAL LOGIC ===
var int bullishBars = 0
var int bearishBars = 0

if new_day
    bullishBars := 0
    bearishBars := 0

if bars_since_new_day < numBarsToCheck and is_bull
    bullishBars += 1
if bars_since_new_day < numBarsToCheck and is_bear
    bearishBars += 1

symbol_size = size.large

if showLabels
    if bullishBars == numBarsToCheck and bars_since_new_day == numBarsToCheck - 1
        label.new(bar_index, high, "ðŸŸ¢", color=color.green, size=symbol_size, textcolor=color.white, style=label.style_label_down, yloc=yloc.abovebar)
    if bearishBars == numBarsToCheck and bars_since_new_day == numBarsToCheck - 1
        label.new(bar_index, high, "ðŸ”´", color=color.red, size=symbol_size, textcolor=color.white, style=label.style_label_down, yloc=yloc.abovebar)

// === BAR COLOURING ===
color barcolour = na
if colourBars
    barcolour := bullishBars == numBarsToCheck and bars_since_new_day < numBarsToCheck ? color.green :
                 bearishBars == numBarsToCheck and bars_since_new_day < numBarsToCheck ? color.red : na
barcolor(barcolour)

// === TOTAL SPIKE LOGIC (ALL CONSECUTIVE BARS) ===
var int streakLength = 0
var float spikeHigh = na
var float spikeLow = na
var bool spikePrinted = false
var bool isBullStreak = na
var float currentTotalSpikeSize = na
var bool spikeCalculated = false

if new_day
    streakLength := 0
    spikeHigh := na
    spikeLow := na
    spikePrinted := false
    isBullStreak := na
    currentTotalSpikeSize := na
    spikeCalculated := false

if in_session and not spikeCalculated
    currentBull = is_bull
    currentBear = is_bear
    continuing = na(isBullStreak) ? true : (isBullStreak ? currentBull : currentBear)

    if continuing
        streakLength += 1
        spikeHigh := na(spikeHigh) ? high : math.max(spikeHigh, high)
        spikeLow := na(spikeLow) ? low : math.min(spikeLow, low)
        if na(isBullStreak)
            isBullStreak := currentBull ? true : false
    else
        if streakLength >= numBarsToCheck
            spikeRange = spikeHigh - spikeLow
            currentTotalSpikeSize := spikeRange
            spikeCalculated := true
            
            // Only show label if toggle is on
            if showSpikeLabel and not spikePrinted
                label.new(bar_index[1], spikeHigh, "Total Spike: " + str.tostring(spikeRange, format.mintick), style = label.style_label_down, textcolor = color.black, color = color.new(color.white, 100), size = size.normal)
                spikePrinted := true

// === NEW: CONSECUTIVE SPIKE (FIRST 2 BARS ONLY) ===
var float bar1High = na
var float bar1Low = na
var float bar2High = na
var float bar2Low = na
var float consecutiveSpikeSize = na

if new_day
    bar1High := na
    bar1Low := na
    bar2High := na
    bar2Low := na
    consecutiveSpikeSize := na

// Capture first bar
if bars_since_new_day == 0
    bar1High := high
    bar1Low := low

// Capture second bar and calculate spike
if bars_since_new_day == 1
    bar2High := high
    bar2Low := low
    
    // Calculate the spike: highest high minus lowest low of first 2 bars
    consecSpikeHigh = math.max(bar1High, bar2High)
    consecSpikeLow = math.min(bar1Low, bar2Low)
    consecutiveSpikeSize := consecSpikeHigh - consecSpikeLow

// === EMAs ===
ema20 = ta.ema(close, 20)
ema200 = ta.ema(close, 200)

plot(showEMA20 ? ema20 : na, "EMA 20", color=color.blue, linewidth=2)
plot(showEMA200 ? ema200 : na, "EMA 200", color=color.red, linewidth=2)

// === DATA WINDOW PLOTS ===

// CSC Bar Type: +1 for bull, -1 for bear, 0 for mixed/none
cscBarType = bullishBars == numBarsToCheck and bars_since_new_day < numBarsToCheck ? 1 :
             bearishBars == numBarsToCheck and bars_since_new_day < numBarsToCheck ? -1 : 0

// Total Spike Size in points (all consecutive bars) - PERSISTS ALL DAY
totalSpikeSize = not na(currentTotalSpikeSize) ? currentTotalSpikeSize : 0

// Consecutive Spike Size in points (first 2 bars only) - PERSISTS ALL DAY
consecSpikeSize = not na(consecutiveSpikeSize) ? consecutiveSpikeSize : 0

// Plot for data export
plot(cscBarType, "CSC Bar Type", color=color.new(color.blue, 100), display=display.data_window)
plot(totalSpikeSize, "Total Spike (pts)", color=color.new(color.orange, 100), display=display.data_window)
plot(consecSpikeSize, "Consecutive Spike (pts)", color=color.new(color.purple, 100), display=display.data_window)
plot(bar_range, "Bar Range", color=color.new(color.gray, 100), display=display.data_window)
plot(averageBarRange, "ABR (8)", color=color.new(color.yellow, 100), display=display.data_window)
plot(barRangeMultiple, "Range Multiple", color=color.new(color.green, 100), display=display.data_window)
plot(ema20, "EMA 20", color=color.new(color.blue, 100), display=display.data_window)
plot(ema200, "EMA 200", color=color.new(color.red, 100), display=display.data_window)
